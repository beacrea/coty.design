name: Create Release Summary

on:
  workflow_dispatch:
    inputs:
      bump_type:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - major
          - minor
          - patch
        default: 'minor'
      package:
        description: 'Package to release'
        required: true
        type: choice
        options:
          - portfolio
          - ask
        default: 'portfolio'

permissions:
  contents: write
  pull-requests: write

jobs:
  create-summary:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Analyze commits and create summary
        id: analyze
        run: |
          PACKAGE="${{ inputs.package }}"

          # Get last release tag for this package
          LAST_TAG=$(git tag --sort=-version:refname | grep "^${PACKAGE}-v" | head -1)
          echo "Last release: $LAST_TAG"

          # Get commits since last release
          if [ -z "$LAST_TAG" ]; then
            COMMITS=$(git log --format="%s" -- ${PACKAGE}/)
          else
            COMMITS=$(git log --format="%s" ${LAST_TAG}..HEAD -- ${PACKAGE}/)
          fi

          # Categorize commits
          FEAT_COUNT=0
          FIX_COUNT=0
          PERF_COUNT=0
          REFACTOR_COUNT=0
          STYLE_COUNT=0

          FEATURES=""
          FIXES=""
          PERF_ITEMS=""

          while IFS= read -r msg; do
            # Skip empty, merge commits, and Replit auto-commits
            if [ -z "$msg" ] || echo "$msg" | grep -qE "^(Merge |Saved progress|Published your App)"; then
              continue
            fi

            # Categorize
            TYPE="chore"

            if echo "$msg" | grep -qiE "^(Add|Introduce|Create|Implement) "; then
              TYPE="feat"
              FEATURES="${FEATURES}- ${msg}\n"
              FEAT_COUNT=$((FEAT_COUNT + 1))
            elif echo "$msg" | grep -qiE "^(Fix|Correct|Resolve|Repair|Restore|Keep) "; then
              TYPE="fix"
              FIXES="${FIXES}- ${msg}\n"
              FIX_COUNT=$((FIX_COUNT + 1))
            elif echo "$msg" | grep -qiE "^(Optimize|\[ImgBot\]|Reduce.*(performance|load))"; then
              TYPE="perf"
              PERF_ITEMS="${PERF_ITEMS}- ${msg}\n"
              PERF_COUNT=$((PERF_COUNT + 1))
            elif echo "$msg" | grep -qiE "^(Improve|Enhance|Increase|Strengthen|Make|Update|Change|Replace|Reduce|Allow|Enable|Animate) "; then
              TYPE="feat"
              FEATURES="${FEATURES}- ${msg}\n"
              FEAT_COUNT=$((FEAT_COUNT + 1))
            elif echo "$msg" | grep -qiE "^(Refactor|Remove|Delete) "; then
              TYPE="refactor"
              REFACTOR_COUNT=$((REFACTOR_COUNT + 1))
            elif echo "$msg" | grep -qiE "^(Adjust|Align|Rearrange) "; then
              TYPE="style"
              STYLE_COUNT=$((STYLE_COUNT + 1))
            fi
          done <<< "$COMMITS"

          # Create summary
          TOTAL=$((FEAT_COUNT + FIX_COUNT + PERF_COUNT + REFACTOR_COUNT + STYLE_COUNT))

          echo "feat_count=$FEAT_COUNT" >> $GITHUB_OUTPUT
          echo "fix_count=$FIX_COUNT" >> $GITHUB_OUTPUT
          echo "perf_count=$PERF_COUNT" >> $GITHUB_OUTPUT
          echo "total=$TOTAL" >> $GITHUB_OUTPUT

          # Save for commit message
          cat > /tmp/release-summary.txt << EOF
          ${{ inputs.bump_type }}($PACKAGE): Release summary

          Accumulated changes since $LAST_TAG:

          Features ($FEAT_COUNT):
          $(echo -e "$FEATURES" | head -20)
          ${FEAT_COUNT -gt 20:+... and $((FEAT_COUNT - 20)) more}

          ${FIX_COUNT -gt 0:+Fixes ($FIX_COUNT):}
          ${FIX_COUNT -gt 0:+$(echo -e "$FIXES")}

          ${PERF_COUNT -gt 0:+Performance ($PERF_COUNT):}
          ${PERF_COUNT -gt 0:+$(echo -e "$PERF_ITEMS")}

          Total commits: $TOTAL
          Refactors: $REFACTOR_COUNT, Styles: $STYLE_COUNT
          EOF

          cat /tmp/release-summary.txt

      - name: Create conventional commit
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git commit --allow-empty -F /tmp/release-summary.txt
          git push origin main

      - name: Trigger Release Please
        run: |
          echo "âœ… Summary commit created. Release Please will run automatically and create a PR."
          echo "Bump type: ${{ inputs.bump_type }}"
          echo "Features: ${{ steps.analyze.outputs.feat_count }}"
          echo "Fixes: ${{ steps.analyze.outputs.fix_count }}"
          echo "Total: ${{ steps.analyze.outputs.total }} commits"
